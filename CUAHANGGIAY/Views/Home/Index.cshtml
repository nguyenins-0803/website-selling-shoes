@using CUAHANGGIAY.Models
@model List<CUAHANGGIAY.Models.SANPHAM>

@{
    ViewBag.Title = "Cửa hàng Laptop";
    Layout = "~/Views/Shared/Layout_KH.cshtml";
}

@{
    var parentCategories = ViewBag.ParentCategories as List<string> ?? new List<string>();
    var childCategories = ViewBag.ChildCategories as List<DANHMUC> ?? new List<DANHMUC>();
    var selectedParentCategory = ViewBag.SelectedParentCategory as string;
    var selectedChildCategory = ViewBag.SelectedChildCategory as string;
}

<head>
    <style>
        /* General Styles */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
        }

        /* Search Bar */
        .search-bar {
            background-color: #f8f9fa;
            padding: 10px;
        }

        /* Sidebar */
        .sidebar {
            background-color: #f8f9fa;
            padding: 20px;
        }

        .nav-link {
            color: #333;
        }

            .nav-link.active, .nav-link:hover {
                background-color: #e9ecef;
            }

        /* Product List */
        .products {
            padding: 20px;
        }

        .card {
            border: 1px solid #ddd;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

            .card:hover {
                transform: translateY(-5px); /* Hiệu ứng hover */
            }

        .container-fluid {
            padding: 0;
        }

        .row {
            margin-left: 0;
            margin-right: 0;
        }

        .search-bar {
            padding: 10px 20px;
        }

        .sidebar {
            padding: 20px 10px;
        }

        .products {
            padding: 20px;
        }

        .card-img-top {
            height: 200px;
            object-fit: cover;
        }

        /* Tạo lớp mới để điều chỉnh độ rộng của cột tìm kiếm */
        .search-col {
            width: 100%;
        }
        /* Định dạng chung cho nút */
        .btn-custom {
            padding: 10px 20px;
            font-size: 14px; /* Đảm bảo kích thước chữ vừa phải */
            font-weight: bold;
            text-align: center;
            border-radius: 5px; /* Đảm bảo góc bo tròn */
            transition: background-color 0.3s ease, transform 0.2s ease-in-out;
            min-width: 150px; /* Đảm bảo chiều rộng cố định */
        }

        /* Nút chi tiết */
        .btn-detail {
            background-color: #007bff;
            color: white;
            border: 1px solid #007bff;
            padding: 10px 20px; /* Đảm bảo nút có padding */
            font-size: 14px;
        }

            /* Nút chi tiết khi hover */
            .btn-detail:hover {
                background-color: #0056b3;
                border-color: #0056b3;
                transform: scale(1.05);
            }

        /* Nút thêm giỏ hàng */
        .btn-cart {
            background-color: #28a745;
            color: white;
            border: 1px solid #28a745;
            padding: 10px 20px; /* Đảm bảo padding nút */
            font-size: 14px;
        }

            /* Nút thêm giỏ hàng khi hover */
            .btn-cart:hover {
                background-color: #218838;
                border-color: #218838;
                transform: scale(1.05);
            }

        /* Bố cục hai nút */
        .button-group {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
        }

    </style>
</head>

<div class="container-fluid">
    <!-- Search Bar -->
    <div class="row search-bar">
        <div class="col-md-12">
            <form action="@Url.Action("SearchProducts", "Home")" method="get" class="d-flex">
                <input class="form-control me-2" type="search" name="searchTerm" placeholder="Tìm kiếm sản phẩm..." aria-label="Search">
                @if (!string.IsNullOrEmpty(selectedChildCategory))
                {
                    <input type="hidden" name="childCategory" value="@selectedChildCategory" />
                }
                <button class="btn btn-outline-success" type="submit">Tìm</button>
            </form>
        </div>
    </div>

    <div class="row">
        <!-- Sidebar -->
        <div class="col-md-3 sidebar">
            <h4>Danh Mục Sản Phẩm</h4>
            <ul class="nav flex-column">
                <li class="nav-item">
                    <a href="#" class="nav-link" data-toggle="collapse" data-target="#collapseNhuCau">
                        Nhu cầu
                    </a>
                    <ul id="collapseNhuCau" class="nav flex-column collapse">
                        <!-- Danh mục con của Nhu cầu sẽ hiển thị ở đây -->
                    </ul>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-toggle="collapse" data-target="#collapseHang">
                        Hãng
                    </a>
                    <ul id="collapseHang" class="nav flex-column collapse">
                        <!-- Danh mục con của Hãng sẽ hiển thị ở đây -->
                    </ul>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-toggle="collapse" data-target="#collapseKhoangGia">
                        Khoảng giá
                    </a>
                    <ul id="collapseKhoangGia" class="nav flex-column collapse">
                        <!-- Danh mục con của Khoảng giá sẽ hiển thị ở đây -->
                    </ul>
                </li>
            </ul>
        </div>

        <!-- Product List -->
        <div class="col-md-9 products">
            <div class="row">
                @if (Model.Any())
                {
                    foreach (var product in Model)
                    {
                        <div class="col-md-3 mb-4">
                            <div class="card h-100">
                                <img src="@Url.Content(product.AnhMinhHoa ?? "~/Images/default.jpg")" class="card-img-top" alt="@product.TenSP">
                                <div class="card-body">
                                    <h5 class="card-title">@product.TenSP</h5>
                                    <p class="card-text text-danger">@product.GiaSP.ToString("N0") VND</p>
                                    <div class="button-group">
                                        <a href="@Url.Action("Details", "SanPham", new { id = product.MaSP })" class="btn btn-primary btn-sm btn-detail">Chi tiết</a>
                                        <a href="javascript:void(0);" onclick="addToCart('@product.MaSP')" class="btn btn-primary btn-sm btn-cart">Thêm giỏ hàng</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                }
                else
                {
                    <p class="text-center text-muted">Không có sản phẩm nào phù hợp.</p>
                }
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>

<script>
    $(document).ready(function () {
        $(".nav-link[data-toggle='collapse']").click(function (e) {
            e.preventDefault();
            var danhMucCha = $(this).text().trim();
            var ul = $(this).siblings("ul");

            // Kiểm tra xem danh sách con có đang được tải hay không
            if (!ul.hasClass("loaded")) {
                // Gọi AJAX để tải danh mục con nếu chưa tải
                $.ajax({
                    url: '@Url.Action("GetDanhMucCon", "Home")',
                    type: 'GET',
                    data: { danhMucCha: danhMucCha },
                    success: function (response) {
                        ul.empty();

                        if (response.data.length > 0) {
                            response.data.forEach(function (item) {
                                ul.append('<li class="nav-item"><a href="#" class="nav-link child-category" data-category-id="' + item.MaDM + '">' + item.TenDM + '</a></li>');
                            });
                        } else {
                            ul.append('<li class="nav-item">Không có danh mục con</li>');
                        }

                        ul.addClass("loaded");
                        ul.collapse("show");
                    },
                    error: function () {
                        alert("Lỗi khi lấy danh mục con!");
                    }
                });
            } else {
                ul.collapse("toggle");
            }
        });
        $(document).on('click', '.btn-cart', function () {
            // Xử lý thêm vào giỏ hàng
        });

        $(document).on('click', '.btn-detail', function () {
            // Xử lý chi tiết sản phẩm
        });

        // Sự kiện khi nhấn vào danh mục con
     $(document).on("click", ".child-category", function (e) {
    e.preventDefault();
         var categoryId = $(this).data("category-id");


    $.ajax({
        url: '@Url.Action("GetProductsByCategory", "Home")',
        type: 'GET',
        data: { categoryId: categoryId },
        success: function (response) {
            var productsContainer = $(".products .row");
            productsContainer.empty();

            if (response.data.length > 0) {
                response.data.forEach(function (product) {
                    productsContainer.append(`
                        <div class="col-md-3 mb-4">
                            <div class="card h-100">
                                <img src="${product.AnhMinhHoa || '~/Images/default.jpg'}" class="card-img-top" alt="${product.TenSP}">
                                <div class="card-body">
                                    <h5 class="card-title">${product.TenSP}</h5>
                                    <p class="card-text text-danger">${product.GiaSP.toLocaleString()} VND</p>
                                    <a href="/SanPham/Details/${product.MaSP}" class="btn btn-primary btn-sm btn-detail">Chi tiết</a>
                                    <a href="javascript:void(0);" onclick="addToCart('${product.MaSP}')" class="btn btn-primary btn-sm btn-cart">Thêm giỏ hàng</a>
                                </div>
                            </div>
                        </div>
                    `);
                });
            } else {
                productsContainer.append('<p class="text-center text-muted">Không có sản phẩm nào phù hợp.</p>');
            }
        },
        error: function () {
            alert("Lỗi khi lấy sản phẩm!");
        }
    });
});

    });

    function addToCart(productId) {
        // Đoạn mã JavaScript thêm sản phẩm vào giỏ hàng
        console.log("Thêm sản phẩm vào giỏ hàng: " + productId);
    }
</script>
